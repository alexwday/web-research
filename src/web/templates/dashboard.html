{% extends "base.html" %}
{% block title %}Dashboard – Deep Research Agent{% endblock %}

{% block content %}
{% set sp = "&session=" ~ session_id|string if session_id else "" %}
{% set sq = "?session=" ~ session_id|string if session_id else "" %}
<h1 class="page-title">Dashboard</h1>

<!-- Start / Stop research -->
{% if running %}
<form class="research-form" hx-post="/api/research/stop" hx-swap="none"
      hx-on::after-request="setTimeout(function(){ window.location.reload(); }, 500)">
    <input type="text" value="{{ session.query if session else '' }}" disabled>
    <button class="btn btn-danger" type="submit">Stop Research</button>
</form>
{% else %}
<form id="start-form">
    <!-- Query row: [input] [Start Research] [Refine Query] -->
    <div class="research-form">
        <input type="text" name="query"
               placeholder="Enter your research query..." required>
        {% if refinement_enabled %}
        <button class="btn btn-ghost" type="button" id="btn-start-direct">Start Research</button>
        <button class="btn btn-primary" type="button" id="btn-refine">Refine Query</button>
        {% else %}
        <button class="btn btn-primary" type="button" id="btn-start-direct">Start Research</button>
        {% endif %}
    </div>

    <!-- Inline refinement container (hidden initially) -->
    {% if refinement_enabled %}
    <div id="refine-inline" style="display:none">
        <!-- Loading spinner -->
        <div id="refine-loading" class="refine-inline-loading" style="display:none">
            <span class="refine-spinner"></span> Generating refinement questions...
        </div>

        <!-- Questions tabs -->
        <div id="refine-questions" style="display:none">
            <div class="refine-tab-bar" id="refine-tab-bar"></div>
            <div id="refine-tab-content" class="refine-tab-content"></div>
            <div class="refine-inline-actions">
                <a href="#" class="refine-skip-link" id="refine-skip-link">Skip, start immediately</a>
            </div>
        </div>

        <!-- Brief review (inline) -->
        <div id="refine-brief-review" style="display:none">
            <div class="refine-brief-section">
                <label for="inline-brief-textarea"><strong>Enhanced Research Brief</strong> (editable):</label>
                <textarea id="inline-brief-textarea" class="refine-brief-textarea" rows="10"></textarea>
            </div>
            <div class="refine-inline-actions">
                <button type="button" class="btn btn-primary" id="btn-start-with-brief">Start Research</button>
                <a href="#" class="refine-skip-link" id="brief-back-link">Back to Questions</a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Preset selector -->
    <input type="hidden" name="preset" id="preset-input" value="quick">
    <div class="preset-selector">
        <div class="preset-buttons">
            <button type="button" class="preset-btn active" data-preset="quick"
                    onclick="selectPreset('quick')">
                <span class="preset-name">Quick</span>
                <span class="preset-desc">3–5 tasks, fast overview</span>
            </button>
            <button type="button" class="preset-btn" data-preset="standard"
                    onclick="selectPreset('standard')">
                <span class="preset-name">Standard</span>
                <span class="preset-desc">8–15 tasks, balanced</span>
            </button>
            <button type="button" class="preset-btn" data-preset="deep"
                    onclick="selectPreset('deep')">
                <span class="preset-name">Deep</span>
                <span class="preset-desc">15–30 tasks, thorough</span>
            </button>
            <button type="button" class="preset-btn" data-preset="exhaustive"
                    onclick="selectPreset('exhaustive')">
                <span class="preset-name">Exhaustive</span>
                <span class="preset-desc">30–50 tasks, maximum depth</span>
            </button>
        </div>
    </div>

    <!-- Advanced settings -->
    <details class="advanced-section">
        <summary class="advanced-toggle">Advanced Settings</summary>
        <div class="advanced-grid">
            <!-- Task Limits -->
            <div class="advanced-group">
                <h4>Task Limits</h4>
                <div class="field">
                    <label for="f-min-tasks">Min Initial Tasks</label>
                    <input type="number" id="f-min-tasks" name="research.min_initial_tasks" min="1" max="100">
                </div>
                <div class="field">
                    <label for="f-max-tasks">Max Total Tasks</label>
                    <input type="number" id="f-max-tasks" name="research.max_total_tasks" min="1" max="200">
                </div>
                <div class="field">
                    <label for="f-max-loops">Max Loops</label>
                    <input type="number" id="f-max-loops" name="research.max_loops" min="-1" max="200">
                    <span class="field-hint">-1 = unlimited</span>
                </div>
                <div class="field">
                    <label for="f-max-runtime">Max Runtime (hours)</label>
                    <input type="number" id="f-max-runtime" name="research.max_runtime_hours" min="1" max="168">
                </div>
            </div>

            <!-- Content Quality -->
            <div class="advanced-group">
                <h4>Content Quality</h4>
                <div class="field">
                    <label for="f-min-words">Min Words / Section</label>
                    <input type="number" id="f-min-words" name="research.min_words_per_section" min="50" max="10000">
                </div>
                <div class="field">
                    <label for="f-max-words">Max Words / Section</label>
                    <input type="number" id="f-max-words" name="research.max_words_per_section" min="100" max="10000">
                </div>
                <div class="field">
                    <label for="f-min-citations">Min Citations / Section</label>
                    <input type="number" id="f-min-citations" name="research.min_citations_per_section" min="0" max="20">
                </div>
            </div>

            <!-- Search -->
            <div class="advanced-group">
                <h4>Search</h4>
                <div class="field">
                    <label for="f-queries-per-task">Queries per Task</label>
                    <input type="number" id="f-queries-per-task" name="search.queries_per_task" min="1" max="10">
                </div>
                <div class="field">
                    <label for="f-max-results">Max Results</label>
                    <input type="number" id="f-max-results" name="search.max_results" min="1" max="20">
                </div>
            </div>

            <!-- Recursion -->
            <div class="advanced-group">
                <h4>Recursion</h4>
                <div class="field field-checkbox">
                    <input type="hidden" name="research.enable_recursion" value="false">
                    <label>
                        <input type="checkbox" id="f-enable-recursion" name="research.enable_recursion" value="true">
                        Enable Recursion
                    </label>
                </div>
                <div class="field">
                    <label for="f-max-recursion">Max Recursion Depth</label>
                    <input type="number" id="f-max-recursion" name="research.max_recursion_depth" min="0" max="5">
                </div>
            </div>
        </div>
    </details>
</form>
{% endif %}

<script>
var PRESETS = {
    quick: {
        "research.min_initial_tasks": 3,
        "research.max_total_tasks": 5,
        "research.min_words_per_section": 100,
        "research.max_words_per_section": 500,
        "research.min_citations_per_section": 1,
        "research.enable_recursion": false,
        "research.max_recursion_depth": 0,
        "research.max_runtime_hours": 1,
        "research.max_loops": 5,
        "search.queries_per_task": 1,
        "search.max_results": 3
    },
    standard: {
        "research.min_initial_tasks": 8,
        "research.max_total_tasks": 15,
        "research.min_words_per_section": 500,
        "research.max_words_per_section": 2000,
        "research.min_citations_per_section": 3,
        "research.enable_recursion": true,
        "research.max_recursion_depth": 1,
        "research.max_runtime_hours": 6,
        "research.max_loops": 15,
        "search.queries_per_task": 2,
        "search.max_results": 5
    },
    deep: {
        "research.min_initial_tasks": 15,
        "research.max_total_tasks": 30,
        "research.min_words_per_section": 1000,
        "research.max_words_per_section": 3000,
        "research.min_citations_per_section": 5,
        "research.enable_recursion": true,
        "research.max_recursion_depth": 2,
        "research.max_runtime_hours": 24,
        "research.max_loops": 30,
        "search.queries_per_task": 3,
        "search.max_results": 8
    },
    exhaustive: {
        "research.min_initial_tasks": 30,
        "research.max_total_tasks": 50,
        "research.min_words_per_section": 2000,
        "research.max_words_per_section": 5000,
        "research.min_citations_per_section": 8,
        "research.enable_recursion": true,
        "research.max_recursion_depth": 3,
        "research.max_runtime_hours": 48,
        "research.max_loops": 50,
        "search.queries_per_task": 4,
        "search.max_results": 10
    }
};

function selectPreset(name) {
    document.getElementById('preset-input').value = name;
    document.querySelectorAll('.preset-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.preset === name);
    });
    var values = PRESETS[name];
    if (!values) return;
    var form = document.getElementById('start-form');
    for (var key in values) {
        var el = form.querySelector('input[name="' + key + '"][type="checkbox"]');
        if (el) { el.checked = !!values[key]; continue; }
        el = form.querySelector('input[name="' + key + '"][type="number"]');
        if (el) { el.value = values[key]; }
    }
}

// ── Helpers ──
function _getFormData() {
    var form = document.getElementById('start-form');
    return new FormData(form);
}

function _startDirect() {
    var form = document.getElementById('start-form');
    var query = form.querySelector('input[name="query"]').value.trim();
    if (!query) { form.querySelector('input[name="query"]').focus(); return; }
    var fd = _getFormData();
    fetch('/api/research/start', { method: 'POST', body: fd })
        .then(function() { setTimeout(function(){ window.location.reload(); }, 1000); })
        .catch(function(err) { alert('Failed to start: ' + err); });
}

// ── Inline refinement state ──
var _refineToken = null;
var _refineQuestions = [];
var _refineAnswers = [];
var _currentTab = 0;

function _showTab(idx) {
    _currentTab = idx;
    var bar = document.getElementById('refine-tab-bar');
    var content = document.getElementById('refine-tab-content');
    if (!_refineQuestions.length) return;

    // Update tab bar
    bar.querySelectorAll('.refine-tab').forEach(function(t, i) {
        t.classList.toggle('active', i === idx);
    });

    var q = _refineQuestions[idx];
    var html = '<div class="refine-question"><h3>' + (idx + 1) + '. ' + _escHtml(q.question) + '</h3>';
    html += '<div class="refine-options">';
    for (var j = 0; j < q.options.length; j++) {
        var checked = (_refineAnswers[idx] === q.options[j]) ? ' checked' : '';
        html += '<label class="refine-option"><input type="radio" name="rq_' + idx + '" value="' + _escAttr(q.options[j]) + '"' + checked + '><span>' + _escHtml(q.options[j]) + '</span></label>';
    }
    var customVal = '';
    var customChecked = '';
    if (_refineAnswers[idx] && q.options.indexOf(_refineAnswers[idx]) === -1) {
        customVal = _refineAnswers[idx];
        customChecked = ' checked';
    }
    html += '<div class="refine-custom-input"><label class="refine-option"><input type="radio" name="rq_' + idx + '" value=""' + customChecked + '><span>Other:</span></label>';
    html += '<input type="text" class="refine-custom-text" placeholder="Type your own answer..." value="' + _escAttr(customVal) + '"></div>';
    html += '</div>';
    // Next button (for custom text or reviewing)
    html += '<div class="refine-next-row"><button type="button" class="btn btn-sm btn-ghost" id="btn-next-q">Next &rarr;</button></div>';
    html += '</div>';
    content.innerHTML = html;

    function _advanceFromCustom() {
        var ci = content.querySelector('.refine-custom-text');
        var val = ci ? ci.value.trim() : '';
        // If "Other" radio is selected, use custom text
        var otherRadio = content.querySelector('.refine-custom-input input[type="radio"]');
        if (otherRadio && otherRadio.checked && val) {
            _refineAnswers[idx] = val;
        }
        // Only advance if this question has an answer
        if (!_refineAnswers[idx]) return;
        _updateTabs();
        if (idx < _refineQuestions.length - 1) {
            setTimeout(function() { _showTab(idx + 1); }, 200);
        }
    }

    // Bind radio option events
    content.querySelectorAll('input[type="radio"]').forEach(function(r) {
        r.addEventListener('change', function() {
            var val = this.value;
            if (val) {
                _refineAnswers[idx] = val;
                _updateTabs();
                if (idx < _refineQuestions.length - 1) {
                    setTimeout(function() { _showTab(idx + 1); }, 300);
                }
            }
        });
    });

    // Custom text input
    var customInput = content.querySelector('.refine-custom-text');
    if (customInput) {
        customInput.addEventListener('focus', function() {
            var radio = this.closest('.refine-custom-input').querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
        });
        customInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                _advanceFromCustom();
            }
        });
    }

    // Next button
    var nextBtn = document.getElementById('btn-next-q');
    if (nextBtn) {
        nextBtn.addEventListener('click', _advanceFromCustom);
    }
}

function _updateTabs() {
    var bar = document.getElementById('refine-tab-bar');
    bar.querySelectorAll('.refine-tab').forEach(function(t, i) {
        var check = t.querySelector('.refine-tab-check');
        if (_refineAnswers[i]) {
            check.textContent = ' \u2713';
        } else {
            check.textContent = '';
        }
    });
    // Auto-start refined research when all questions answered
    var allAnswered = _refineAnswers.every(function(a) { return !!a; });
    if (allAnswered && !_refineAutoStarted) {
        _refineAutoStarted = true;
        _startRefinedResearch();
    }
}

var _refineAutoStarted = false;

function _startRefinedResearch() {
    var answers = _refineQuestions.map(function(q, i) {
        return { question: q.question, answer: _refineAnswers[i] || '' };
    });

    // Show generating state
    var questionsDiv = document.getElementById('refine-questions');
    var loadingDiv = document.getElementById('refine-loading');
    questionsDiv.style.display = 'none';
    loadingDiv.querySelector('.refine-spinner + span') || loadingDiv;
    loadingDiv.innerHTML = '<span class="refine-spinner"></span> Generating brief and starting research...';
    loadingDiv.style.display = '';

    fetch('/api/research/brief', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ token: _refineToken, answers: answers })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        // Show brief for review before final start
        loadingDiv.style.display = 'none';
        document.getElementById('inline-brief-textarea').value = data.brief || '';
        document.getElementById('refine-brief-review').style.display = '';
    })
    .catch(function(err) {
        loadingDiv.style.display = 'none';
        questionsDiv.style.display = '';
        _refineAutoStarted = false;
        alert('Brief generation failed: ' + err);
    });
}

function _buildTabBar() {
    var bar = document.getElementById('refine-tab-bar');
    bar.innerHTML = '';
    for (var i = 0; i < _refineQuestions.length; i++) {
        var tab = document.createElement('button');
        tab.type = 'button';
        tab.className = 'refine-tab' + (i === 0 ? ' active' : '');
        tab.textContent = 'Q' + (i + 1);
        var check = document.createElement('span');
        check.className = 'refine-tab-check';
        tab.appendChild(check);
        tab.dataset.idx = i;
        tab.addEventListener('click', function() { _showTab(parseInt(this.dataset.idx)); });
        bar.appendChild(tab);
    }
}

function _escHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function _escAttr(s) { return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('start-form')) {
        selectPreset('quick');
    }

    // "Start Research" (skip refinement)
    var btnStart = document.getElementById('btn-start-direct');
    if (btnStart) btnStart.addEventListener('click', _startDirect);

    // "Refine Query" button
    var btnRefine = document.getElementById('btn-refine');
    if (btnRefine) {
        btnRefine.addEventListener('click', function() {
            var form = document.getElementById('start-form');
            var query = form.querySelector('input[name="query"]').value.trim();
            if (!query) { form.querySelector('input[name="query"]').focus(); return; }

            var container = document.getElementById('refine-inline');
            var loading = document.getElementById('refine-loading');
            container.style.display = '';
            loading.style.display = '';
            document.getElementById('refine-questions').style.display = 'none';
            document.getElementById('refine-brief-review').style.display = 'none';
            btnRefine.disabled = true;

            // Build JSON body with form data
            var body = { query: query, preset: document.getElementById('preset-input').value };
            form.querySelectorAll('input[name]').forEach(function(el) {
                if (el.name.indexOf('.') !== -1) {
                    if (el.type === 'checkbox') { body[el.name] = el.checked ? 'true' : 'false'; }
                    else if (el.type === 'number' && el.value) { body[el.name] = el.value; }
                }
            });

            fetch('/api/research/refine', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading.style.display = 'none';
                btnRefine.disabled = false;
                _refineToken = data.token;
                _refineQuestions = data.questions || [];
                _refineAnswers = new Array(_refineQuestions.length).fill('');
                _buildTabBar();
                document.getElementById('refine-questions').style.display = '';
                _showTab(0);
            })
            .catch(function(err) {
                loading.style.display = 'none';
                btnRefine.disabled = false;
                alert('Refinement failed: ' + err);
            });
        });
    }

    // "Start Research" with brief
    var btnStartBrief = document.getElementById('btn-start-with-brief');
    if (btnStartBrief) {
        btnStartBrief.addEventListener('click', function() {
            var brief = document.getElementById('inline-brief-textarea').value;
            var fd = new FormData();
            fd.append('token', _refineToken);
            fd.append('brief', brief);
            fetch('/api/research/start-refined', { method: 'POST', body: fd, redirect: 'follow' })
                .then(function() { setTimeout(function(){ window.location.reload(); }, 1000); })
                .catch(function(err) { alert('Failed to start: ' + err); });
        });
    }

    // "Skip, start immediately" link in questions view
    var skipLink = document.getElementById('refine-skip-link');
    if (skipLink) {
        skipLink.addEventListener('click', function(e) { e.preventDefault(); _startDirect(); });
    }

    // "Back to Questions" link in brief view
    var backLink = document.getElementById('brief-back-link');
    if (backLink) {
        backLink.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('refine-brief-review').style.display = 'none';
            document.getElementById('refine-questions').style.display = '';
        });
    }
});
</script>

<!-- Session info -->
{% if session %}
<div class="session-info">
    <strong>Query:</strong> {{ session.query[:200] }}{% if session.query|length > 200 %}...{% endif %}<br>
    {% if session.refined_brief %}
    <strong>Refined Brief:</strong> {{ session.refined_brief[:300] }}{% if session.refined_brief|length > 300 %}...{% endif %}<br>
    {% endif %}
    <strong>Started:</strong> {{ session.started_at }}<br>
    <strong>Status:</strong> {{ session.status }}
</div>
{% endif %}

<!-- Stats grid (polled) -->
<div id="stats-area"
     hx-get="/fragments/stats{{ sq }}"
     hx-trigger="every 5s"
     hx-swap="innerHTML">
    {% include "fragments/stats.html" %}
</div>

<!-- Unified activity log (polled) -->
{% if session %}
<div class="activity-section">
    <h3 class="activity-heading">Activity Log</h3>
    <div id="activity-log-area"
         hx-get="/fragments/search-activity{{ sq }}"
         hx-trigger="every 3s"
         hx-swap="innerHTML">
        {% include "fragments/search_activity.html" %}
    </div>
</div>
{% endif %}

<!-- Client-side elapsed timer (ticks between HTMX polls) -->
<script>
(function() {
    var timerInterval = null;
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(function() {
            var el = document.querySelector('.elapsed-timer');
            if (!el) { clearInterval(timerInterval); timerInterval = null; return; }
            var secs = parseInt(el.dataset.start, 10) || 0;
            secs++;
            el.dataset.start = secs;
            var h = Math.floor(secs / 3600);
            var m = Math.floor((secs % 3600) / 60);
            var s = secs % 60;
            el.textContent = h + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }, 1000);
    }
    document.addEventListener('DOMContentLoaded', startTimer);
    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target && e.detail.target.id === 'stats-area') {
            startTimer();
        }
    });
})();
</script>
{% endblock %}
