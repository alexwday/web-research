{% extends "base.html" %}
{% block title %}Dashboard – Deep Research Agent{% endblock %}
{% block container_class %}dashboard-container{% endblock %}

{% block content %}
{% set sp = "&session=" ~ session_id|string if session_id else "" %}
{% set sq = "?session=" ~ session_id|string if session_id else "" %}

<div class="dashboard-three-col">
    <aside class="dashboard-sidebar dashboard-sidebar-left" id="sessions-sidebar">
        <div class="dashboard-sidebar-card sessions-sidebar-card">
            <div class="dashboard-sidebar-header">
                <h2 class="dashboard-sidebar-title">Sessions</h2>
                <span class="sidebar-count">{{ session_rows|length }}</span>
            </div>

            {% if session_rows %}
            <ul class="sessions-sidebar-list">
                {% for row in session_rows %}
                {% set s = row.session %}
                {% set st = row.stats %}
                <li class="session-sidebar-item {% if session and s.id == session.id %}active{% endif %}">
                    <a class="session-sidebar-link" href="/dashboard?session={{ s.id }}">
                        <div class="session-sidebar-title">#{{ s.id }} · {{ s.query[:72] }}{% if s.query|length > 72 %}...{% endif %}</div>
                        <div class="session-sidebar-meta">
                            <span class="badge badge-{{ s.status }}">{{ s.status }}</span>
                            <span>{{ st.completed_tasks }}/{{ st.total_tasks }} tasks</span>
                            <span>{{ "{:,}".format(st.total_words) }} words</span>
                            <span>{{ st.total_sources }} sources</span>
                        </div>
                        <div class="session-sidebar-submeta">
                            {{ s.started_at.strftime('%Y-%m-%d %H:%M') if s.started_at else '-' }}
                        </div>
                    </a>
                    <div class="session-sidebar-actions">
                        <a href="/dashboard?session={{ s.id }}" class="btn btn-sm btn-outline">Open</a>
                        {% if s.report_html_path %}
                        <a href="/report?session={{ s.id }}" class="btn btn-sm btn-primary">Report</a>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="activity-empty">No sessions yet.</p>
            {% endif %}
        </div>
    </aside>

    <main class="dashboard-main">
        <h1 class="page-title">Dashboard</h1>

        <!-- Start / Stop research -->
        {% if running %}
        <form class="research-form" hx-post="/api/research/stop" hx-swap="none"
              hx-on::after-request="setTimeout(function(){ window.location.reload(); }, 500)">
            <input type="text" value="{{ session.query if session else '' }}" disabled>
            <button class="btn btn-danger" type="submit">Stop Research</button>
        </form>
        {% else %}
        <form id="start-form">
            <input type="hidden" name="preset" id="preset-input" value="quick">

            <!-- Preset selector + advanced settings (above query input) -->
            <div class="start-config-block">
                <div class="advanced-section" id="advanced-settings">
                    <div class="preset-controls-row">
                        <div class="preset-selector">
                            <div class="preset-buttons">
                                <button type="button" class="preset-btn active" data-preset="quick"
                                        onclick="selectPreset('quick')">
                                    <span class="preset-name">Quick</span>
                                </button>
                                <button type="button" class="preset-btn" data-preset="standard"
                                        onclick="selectPreset('standard')">
                                    <span class="preset-name">Standard</span>
                                </button>
                                <button type="button" class="preset-btn" data-preset="deep"
                                        onclick="selectPreset('deep')">
                                    <span class="preset-name">Deep</span>
                                </button>
                                <button type="button" class="preset-btn" data-preset="exhaustive"
                                        onclick="selectPreset('exhaustive')">
                                    <span class="preset-name">Exhaustive</span>
                                </button>
                            </div>
                        </div>
                        <button
                            type="button"
                            class="advanced-toggle-btn"
                            id="advanced-toggle-btn"
                            aria-expanded="false"
                            aria-controls="advanced-settings-panel"
                        >
                            Advanced Settings
                        </button>
                    </div>

                    <div class="advanced-panel" id="advanced-settings-panel" hidden>
                        <div class="advanced-grid">
                        <!-- Task Limits -->
                        <div class="advanced-group">
                            <h4>Task Limits</h4>
                            <div class="field">
                                <label for="f-min-tasks">Min Initial Tasks</label>
                                <input type="number" id="f-min-tasks" name="research.min_initial_tasks" min="1" max="100">
                            </div>
                            <div class="field">
                                <label for="f-max-tasks">Max Total Tasks</label>
                                <input type="number" id="f-max-tasks" name="research.max_total_tasks" min="1" max="200">
                            </div>
                            <div class="field">
                                <label for="f-max-loops">Max Loops</label>
                                <input type="number" id="f-max-loops" name="research.max_loops" min="-1" max="200">
                                <span class="field-hint">-1 = unlimited</span>
                            </div>
                            <div class="field">
                                <label for="f-max-runtime">Max Runtime (hours)</label>
                                <input type="number" id="f-max-runtime" name="research.max_runtime_hours" min="1" max="168">
                            </div>
                        </div>

                        <!-- Content Quality -->
                        <div class="advanced-group">
                            <h4>Content Quality</h4>
                            <div class="field">
                                <label for="f-min-words">Min Words / Section</label>
                                <input type="number" id="f-min-words" name="research.min_words_per_section" min="50" max="10000">
                            </div>
                            <div class="field">
                                <label for="f-max-words">Max Words / Section</label>
                                <input type="number" id="f-max-words" name="research.max_words_per_section" min="100" max="10000">
                            </div>
                            <div class="field">
                                <label for="f-min-citations">Min Citations / Section</label>
                                <input type="number" id="f-min-citations" name="research.min_citations_per_section" min="0" max="20">
                            </div>
                        </div>

                        <!-- Search -->
                        <div class="advanced-group">
                            <h4>Search</h4>
                            <div class="field">
                                <label for="f-queries-per-task">Queries per Task</label>
                                <input type="number" id="f-queries-per-task" name="search.queries_per_task" min="1" max="10">
                            </div>
                            <div class="field">
                                <label for="f-results-per-query">Results per Query</label>
                                <input type="number" id="f-results-per-query" name="search.results_per_query" min="1" max="10">
                            </div>
                        </div>

                        <!-- Recursion -->
                        <div class="advanced-group">
                            <h4>Recursion</h4>
                            <div class="field field-checkbox">
                                <input type="hidden" name="research.enable_recursion" value="false">
                                <label>
                                    <input type="checkbox" id="f-enable-recursion" name="research.enable_recursion" value="true">
                                    Enable Recursion
                                </label>
                            </div>
                            <div class="field">
                                <label for="f-max-recursion">Max Recursion Depth</label>
                                <input type="number" id="f-max-recursion" name="research.max_recursion_depth" min="0" max="5">
                            </div>
                        </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Query row: [input] [Start Research] [Refine Query] -->
            <div class="research-form">
                <input type="text" name="query"
                       placeholder="Enter your research query..." required>
                {% if refinement_enabled %}
                <button class="btn btn-ghost" type="button" id="btn-start-direct">Start Research</button>
                <button class="btn btn-primary" type="button" id="btn-refine">Refine Query</button>
                {% else %}
                <button class="btn btn-primary" type="button" id="btn-start-direct">Start Research</button>
                {% endif %}
            </div>

            <!-- Inline refinement container (hidden initially) -->
            {% if refinement_enabled %}
            <div id="refine-inline" style="display:none">
                <!-- Loading spinner -->
                <div id="refine-loading" class="refine-inline-loading" style="display:none">
                    <span class="refine-spinner"></span> Generating refinement questions...
                </div>

                <!-- Questions tabs -->
                <div id="refine-questions" style="display:none">
                    <div class="refine-tab-bar" id="refine-tab-bar"></div>
                    <div id="refine-tab-content" class="refine-tab-content"></div>
                    <div class="refine-inline-actions">
                        <a href="#" class="refine-skip-link" id="refine-skip-link">Skip, start immediately</a>
                    </div>
                </div>

                <!-- Brief review (inline) -->
                <div id="refine-brief-review" style="display:none">
                    <div class="refine-brief-section">
                        <label for="inline-brief-textarea"><strong>Enhanced Research Brief</strong> (editable):</label>
                        <textarea id="inline-brief-textarea" class="refine-brief-textarea" rows="10"></textarea>
                    </div>
                    <div class="refine-inline-actions">
                        <button type="button" class="btn btn-primary" id="btn-start-with-brief">Start Research</button>
                        <a href="#" class="refine-skip-link" id="brief-back-link">Back to Questions</a>
                    </div>
                </div>
            </div>
            {% endif %}
        </form>
        {% endif %}

        <!-- Session info + metrics (polled) -->
        {% if session %}
        <div class="session-info"
             id="session-info-area"
             hx-get="/fragments/session-info{{ sq }}"
             hx-trigger="every 5s"
             hx-swap="innerHTML">
            {% include "fragments/session_info.html" %}
        </div>
        {% endif %}
    </main>

    <aside class="dashboard-sidebar dashboard-sidebar-right">
        <div class="dashboard-sidebar-card">
            <h2 class="dashboard-sidebar-title">Activity Log</h2>
            <div id="activity-log-area"
                 hx-get="/fragments/search-activity{{ sq }}"
                 hx-trigger="every 3s"
                 hx-swap="innerHTML"
                 hx-on::before-swap="var fl = this.querySelector('.feed-list'); this._feedScroll = fl?.scrollTop; this._collapsed = []; this.querySelectorAll('.feed-task-group.collapsed').forEach(function(g,i){ this._collapsed.push(i) }.bind(this))"
                 hx-on::after-swap="var fl = this.querySelector('.feed-list'); if (fl && this._feedScroll != null) fl.scrollTop = this._feedScroll; if (this._collapsed) { var gs = this.querySelectorAll('.feed-task-group'); this._collapsed.forEach(function(i){ if(gs[i]) gs[i].classList.add('collapsed') }) }">
                {% include "fragments/search_activity.html" %}
            </div>
        </div>
    </aside>
</div>

<script>
var PRESETS = {
    quick: {
        "research.min_initial_tasks": 3,
        "research.max_total_tasks": 10,
        "research.enable_recursion": false,
        "research.max_recursion_depth": 0,
        "research.max_runtime_hours": 1,
        "research.max_loops": 10,
        "research.min_words_per_section": 200,
        "research.max_words_per_section": 600,
        "research.min_citations_per_section": 1,
        "search.queries_per_task": 3,
        "search.results_per_query": 2
    },
    standard: {
        "research.min_initial_tasks": 5,
        "research.max_total_tasks": 25,
        "research.enable_recursion": true,
        "research.max_recursion_depth": 1,
        "research.max_runtime_hours": 2,
        "research.max_loops": 25,
        "research.min_words_per_section": 400,
        "research.max_words_per_section": 1500,
        "research.min_citations_per_section": 2,
        "search.queries_per_task": 4,
        "search.results_per_query": 2
    },
    deep: {
        "research.min_initial_tasks": 8,
        "research.max_total_tasks": 50,
        "research.enable_recursion": true,
        "research.max_recursion_depth": 2,
        "research.max_runtime_hours": 6,
        "research.max_loops": 50,
        "research.min_words_per_section": 800,
        "research.max_words_per_section": 2500,
        "research.min_citations_per_section": 4,
        "search.queries_per_task": 5,
        "search.results_per_query": 2
    },
    exhaustive: {
        "research.min_initial_tasks": 12,
        "research.max_total_tasks": 100,
        "research.enable_recursion": true,
        "research.max_recursion_depth": 3,
        "research.max_runtime_hours": 24,
        "research.max_loops": 100,
        "research.min_words_per_section": 1500,
        "research.max_words_per_section": 4000,
        "research.min_citations_per_section": 6,
        "search.queries_per_task": 6,
        "search.results_per_query": 2
    }
};

function selectPreset(name) {
    var form = document.getElementById('start-form');
    if (!form) return;

    document.getElementById('preset-input').value = name;
    document.querySelectorAll('.preset-btn').forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.preset === name);
    });
    var values = PRESETS[name];
    if (!values) return;

    for (var key in values) {
        var el = form.querySelector('input[name="' + key + '"][type="checkbox"]');
        if (el) { el.checked = !!values[key]; continue; }
        el = form.querySelector('input[name="' + key + '"][type="number"]');
        if (el) { el.value = values[key]; }
    }
}

function _getFormData() {
    var form = document.getElementById('start-form');
    return new FormData(form);
}

function _setQueryRowDisabled(disabled) {
    var form = document.getElementById('start-form');
    if (!form) return;
    var queryInput = form.querySelector('input[name="query"]');
    var btnStart = document.getElementById('btn-start-direct');
    var btnRefine = document.getElementById('btn-refine');
    if (queryInput) queryInput.disabled = disabled;
    if (btnStart) btnStart.disabled = disabled;
    if (btnRefine) btnRefine.disabled = disabled;
}

function _setConfigControlsDisabled(disabled) {
    var form = document.getElementById('start-form');
    if (!form) return;

    var presetSelector = form.querySelector('.preset-selector');
    if (presetSelector) {
        presetSelector.classList.toggle('is-disabled', disabled);
    }

    form.querySelectorAll('.preset-btn').forEach(function(btn) {
        btn.disabled = disabled;
    });

    var advancedSection = form.querySelector('.advanced-section');
    var advancedToggleBtn = form.querySelector('#advanced-toggle-btn');
    var advancedPanel = form.querySelector('#advanced-settings-panel');

    if (advancedToggleBtn) {
        advancedToggleBtn.disabled = disabled;
        advancedToggleBtn.classList.toggle('is-disabled', disabled);
    }

    if (disabled && advancedPanel && !advancedPanel.hidden) {
        advancedPanel.dataset.wasOpen = '1';
        advancedPanel.hidden = true;
        if (advancedToggleBtn) advancedToggleBtn.setAttribute('aria-expanded', 'false');
    }

    if (!disabled && advancedPanel && advancedPanel.dataset.wasOpen === '1') {
        advancedPanel.hidden = false;
        if (advancedToggleBtn) advancedToggleBtn.setAttribute('aria-expanded', 'true');
        delete advancedPanel.dataset.wasOpen;
    }

    if (advancedSection) {
        advancedSection.classList.toggle('is-disabled', disabled);
    }
    if (advancedPanel) {
        advancedPanel.classList.toggle('is-disabled', disabled);
    }
}

function _setStartFormDisabled(disabled) {
    _setQueryRowDisabled(disabled);
    _setConfigControlsDisabled(disabled);
}

function _startDirect() {
    var form = document.getElementById('start-form');
    var queryInput = form.querySelector('input[name="query"]');

    var wasDisabled = queryInput.disabled;
    queryInput.disabled = false;
    var query = queryInput.value.trim();
    if (!query) {
        queryInput.focus();
        queryInput.disabled = wasDisabled;
        return;
    }

    var fd = _getFormData();
    queryInput.disabled = wasDisabled;

    _setStartFormDisabled(true);

    fetch('/api/research/start', { method: 'POST', body: fd })
        .then(function() { setTimeout(function(){ window.location.reload(); }, 1000); })
        .catch(function(err) {
            _setStartFormDisabled(false);
            alert('Failed to start: ' + err);
        });
}

var _refineToken = null;
var _refineQuestions = [];
var _refineAnswers = [];
var _currentTab = 0;

function _showTab(idx) {
    _currentTab = idx;
    var bar = document.getElementById('refine-tab-bar');
    var content = document.getElementById('refine-tab-content');
    if (!_refineQuestions.length) return;

    bar.querySelectorAll('.refine-tab').forEach(function(t, i) {
        t.classList.toggle('active', i === idx);
    });

    var q = _refineQuestions[idx];
    var html = '<div class="refine-question"><h3>' + (idx + 1) + '. ' + _escHtml(q.question) + '</h3>';
    html += '<div class="refine-options">';
    for (var j = 0; j < q.options.length; j++) {
        var checked = (_refineAnswers[idx] === q.options[j]) ? ' checked' : '';
        html += '<label class="refine-option"><input type="radio" name="rq_' + idx + '" value="' + _escAttr(q.options[j]) + '"' + checked + '><span>' + _escHtml(q.options[j]) + '</span></label>';
    }
    var customVal = '';
    var customChecked = '';
    if (_refineAnswers[idx] && q.options.indexOf(_refineAnswers[idx]) === -1) {
        customVal = _refineAnswers[idx];
        customChecked = ' checked';
    }
    html += '<div class="refine-custom-input"><label class="refine-option"><input type="radio" name="rq_' + idx + '" value=""' + customChecked + '><span>Other:</span></label>';
    html += '<input type="text" class="refine-custom-text" placeholder="Type your own answer..." value="' + _escAttr(customVal) + '"></div>';
    html += '</div>';
    html += '<div class="refine-next-row"><button type="button" class="btn btn-sm btn-ghost" id="btn-next-q">Next &rarr;</button></div>';
    html += '</div>';
    content.innerHTML = html;

    function _advanceFromCustom() {
        var ci = content.querySelector('.refine-custom-text');
        var val = ci ? ci.value.trim() : '';
        var otherRadio = content.querySelector('.refine-custom-input input[type="radio"]');
        if (otherRadio && otherRadio.checked && val) {
            _refineAnswers[idx] = val;
        }
        if (!_refineAnswers[idx]) return;
        _updateTabs();
        if (idx < _refineQuestions.length - 1) {
            setTimeout(function() { _showTab(idx + 1); }, 200);
        }
    }

    content.querySelectorAll('input[type="radio"]').forEach(function(r) {
        r.addEventListener('change', function() {
            var val = this.value;
            if (val) {
                _refineAnswers[idx] = val;
                _updateTabs();
                if (idx < _refineQuestions.length - 1) {
                    setTimeout(function() { _showTab(idx + 1); }, 300);
                }
            }
        });
    });

    var customInput = content.querySelector('.refine-custom-text');
    if (customInput) {
        customInput.addEventListener('focus', function() {
            var radio = this.closest('.refine-custom-input').querySelector('input[type="radio"]');
            if (radio) radio.checked = true;
        });
        customInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                _advanceFromCustom();
            }
        });
    }

    var nextBtn = document.getElementById('btn-next-q');
    if (nextBtn) {
        nextBtn.addEventListener('click', _advanceFromCustom);
    }
}

function _updateTabs() {
    var bar = document.getElementById('refine-tab-bar');
    bar.querySelectorAll('.refine-tab').forEach(function(t, i) {
        var check = t.querySelector('.refine-tab-check');
        if (_refineAnswers[i]) {
            check.textContent = ' \u2713';
        } else {
            check.textContent = '';
        }
    });
    var allAnswered = _refineAnswers.every(function(a) { return !!a; });
    if (allAnswered && !_refineAutoStarted) {
        _refineAutoStarted = true;
        _startRefinedResearch();
    }
}

var _refineAutoStarted = false;

function _startRefinedResearch() {
    var answers = _refineQuestions.map(function(q, i) {
        return { question: q.question, answer: _refineAnswers[i] || '' };
    });

    var questionsDiv = document.getElementById('refine-questions');
    var loadingDiv = document.getElementById('refine-loading');
    questionsDiv.style.display = 'none';
    loadingDiv.querySelector('.refine-spinner + span') || loadingDiv;
    loadingDiv.innerHTML = '<span class="refine-spinner"></span> Generating brief and starting research...';
    loadingDiv.style.display = '';

    fetch('/api/research/brief', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify({ token: _refineToken, answers: answers })
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        loadingDiv.style.display = 'none';
        document.getElementById('inline-brief-textarea').value = data.brief || '';
        document.getElementById('refine-brief-review').style.display = '';
    })
    .catch(function(err) {
        loadingDiv.style.display = 'none';
        questionsDiv.style.display = '';
        _refineAutoStarted = false;
        alert('Brief generation failed: ' + err);
    });
}

function _buildTabBar() {
    var bar = document.getElementById('refine-tab-bar');
    bar.innerHTML = '';
    for (var i = 0; i < _refineQuestions.length; i++) {
        var tab = document.createElement('button');
        tab.type = 'button';
        tab.className = 'refine-tab' + (i === 0 ? ' active' : '');
        tab.textContent = 'Q' + (i + 1);
        var check = document.createElement('span');
        check.className = 'refine-tab-check';
        tab.appendChild(check);
        tab.dataset.idx = i;
        tab.addEventListener('click', function() { _showTab(parseInt(this.dataset.idx)); });
        bar.appendChild(tab);
    }
}

function _escHtml(s) { var d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
function _escAttr(s) { return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/'/g,'&#39;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('start-form')) {
        selectPreset('quick');
    }

    var advancedToggleBtn = document.getElementById('advanced-toggle-btn');
    if (advancedToggleBtn) {
        advancedToggleBtn.addEventListener('click', function() {
            var panel = document.getElementById('advanced-settings-panel');
            if (!panel) return;
            var isOpen = !panel.hidden;
            panel.hidden = isOpen;
            this.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
        });
    }

    var btnStart = document.getElementById('btn-start-direct');
    if (btnStart) btnStart.addEventListener('click', _startDirect);

    var btnRefine = document.getElementById('btn-refine');
    if (btnRefine) {
        btnRefine.addEventListener('click', function() {
            var form = document.getElementById('start-form');
            var query = form.querySelector('input[name="query"]').value.trim();
            if (!query) { form.querySelector('input[name="query"]').focus(); return; }

            var container = document.getElementById('refine-inline');
            var loading = document.getElementById('refine-loading');
            container.style.display = '';
            loading.style.display = '';
            document.getElementById('refine-questions').style.display = 'none';
            document.getElementById('refine-brief-review').style.display = 'none';
            _setStartFormDisabled(true);

            var body = { query: query, preset: document.getElementById('preset-input').value };
            form.querySelectorAll('input[name]').forEach(function(el) {
                if (el.name.indexOf('.') !== -1) {
                    if (el.type === 'checkbox') { body[el.name] = el.checked ? 'true' : 'false'; }
                    else if (el.type === 'number' && el.value) { body[el.name] = el.value; }
                }
            });

            fetch('/api/research/refine', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                loading.style.display = 'none';
                _refineToken = data.token;
                _refineQuestions = data.questions || [];
                _refineAnswers = new Array(_refineQuestions.length).fill('');
                _buildTabBar();
                document.getElementById('refine-questions').style.display = '';
                _showTab(0);
            })
            .catch(function(err) {
                loading.style.display = 'none';
                _setStartFormDisabled(false);
                container.style.display = 'none';
                alert('Refinement failed: ' + err);
            });
        });
    }

    var btnStartBrief = document.getElementById('btn-start-with-brief');
    if (btnStartBrief) {
        btnStartBrief.addEventListener('click', function() {
            var brief = document.getElementById('inline-brief-textarea').value;
            var fd = new FormData();
            fd.append('token', _refineToken);
            fd.append('brief', brief);
            fetch('/api/research/start-refined', { method: 'POST', body: fd, redirect: 'follow' })
                .then(function() { setTimeout(function(){ window.location.reload(); }, 1000); })
                .catch(function(err) { alert('Failed to start: ' + err); });
        });
    }

    var skipLink = document.getElementById('refine-skip-link');
    if (skipLink) {
        skipLink.addEventListener('click', function(e) { e.preventDefault(); _startDirect(); });
    }

    var backLink = document.getElementById('brief-back-link');
    if (backLink) {
        backLink.addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('refine-brief-review').style.display = 'none';
            document.getElementById('refine-questions').style.display = '';
        });
    }
});
</script>

<!-- Client-side elapsed timer (ticks between HTMX polls) -->
<script>
(function() {
    var timerInterval = null;
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(function() {
            var el = document.querySelector('.elapsed-timer');
            if (!el) { clearInterval(timerInterval); timerInterval = null; return; }
            var secs = parseInt(el.dataset.start, 10) || 0;
            secs++;
            el.dataset.start = secs;
            var h = Math.floor(secs / 3600);
            var m = Math.floor((secs % 3600) / 60);
            var s = secs % 60;
            el.textContent = h + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
        }, 1000);
    }
    document.addEventListener('DOMContentLoaded', startTimer);
    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target && (e.detail.target.id === 'stats-area' || e.detail.target.id === 'session-info-area')) {
            startTimer();
        }
    });
})();
</script>
{% endblock %}
