{% set session_status = session.status if session is defined and session and session.status else "unknown" %}

<div class="session-info-grid">
    <div class="session-info-item session-info-item-wide">
        <div class="session-info-label">Query</div>
        <p class="session-info-value session-info-value-text">
            {{ session.query[:200] }}{% if session.query|length > 200 %}...{% endif %}
        </p>
    </div>

    {% if session.refined_brief %}
    <div class="session-info-item session-info-item-wide">
        <div class="session-info-label">Refined Brief</div>
        <p class="session-info-value session-info-value-text">
            {{ session.refined_brief[:300] }}{% if session.refined_brief|length > 300 %}...{% endif %}
        </p>
        {% if session.refined_brief|length > 300 %}
        <details class="session-brief-details">
            <summary class="session-brief-summary">Show full refined brief</summary>
            <p class="session-info-value session-info-value-text session-brief-full">
                {{ session.refined_brief }}
            </p>
        </details>
        {% endif %}
    </div>
    {% endif %}
</div>

{# ── Metrics tiles ──────────────────────────────────── #}
{% set total = stats.get("total_tasks", 0) if stats is defined else 0 %}
{% set done = stats.get("completed_tasks", 0) if stats is defined else 0 %}
{% set pending = stats.get("pending_tasks", 0) if stats is defined else 0 %}
{% set failed = stats.get("failed_tasks", 0) if stats is defined else 0 %}
{% set pct = ((done / total * 100) | round | int) if total > 0 else 0 %}
{% set circ = 113 %}
{% set offset = circ - (circ * pct / 100) %}
{% set r = running if running is defined else false %}
{% set p = phase if phase is defined else "idle" %}
{% set el = elapsed_seconds if elapsed_seconds is defined else 0 %}

<div class="stats-panels session-stats-panels">

    {# ── Pipeline panel ─────────────────────────────────── #}
    <div class="sp-panel sp-blue">
        <div class="sp-header">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
            <span>Pipeline</span>
            {% if r or p != "idle" %}
            <span class="sp-phase-label">
                <span class="phase-dot {% if r %}phase-dot-active{% endif %}"></span>
                {% if p == "pre_planning" %}Pre-planning
                {% elif p == "outline_design" %}Designing outline
                {% elif p == "task_planning" %}Planning tasks
                {% elif p == "researching" %}Researching
                {% elif p == "gap_analysis" %}Analyzing gaps
                {% elif p == "synthesizing" %}Synthesizing
                {% elif p == "compiling" %}Compiling
                {% elif p == "complete" %}Complete
                {% else %}Running
                {% endif %}
            </span>
            {% endif %}
        </div>
        <div class="sp-body sp-pipeline-body">
            <div class="sp-ring-wrap">
                <svg class="sp-ring" viewBox="0 0 44 44">
                    <circle cx="22" cy="22" r="18" fill="none" stroke="#e2e8f0" stroke-width="4"/>
                    <circle cx="22" cy="22" r="18" fill="none" stroke="var(--blue)" stroke-width="4"
                            stroke-dasharray="{{ circ }}" stroke-dashoffset="{{ offset }}"
                            stroke-linecap="round" transform="rotate(-90 22 22)"/>
                </svg>
                <span class="sp-ring-pct">{{ pct }}%</span>
            </div>
            <div class="sp-breakdown">
                <div class="sp-stat"><span class="sp-stat-val">{{ total }}</span> Total</div>
                <div class="sp-stat"><span class="sp-stat-val">{{ done }}</span> Done</div>
                <div class="sp-stat"><span class="sp-stat-val">{{ pending }}</span> Pending</div>
                {% if failed > 0 %}
                <div class="sp-stat sp-stat-fail"><span class="sp-stat-val">{{ failed }}</span> Failed</div>
                {% endif %}
            </div>
        </div>
    </div>

    {# ── Content panel ──────────────────────────────────── #}
    <div class="sp-panel sp-green">
        <div class="sp-header">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            <span>Content</span>
        </div>
        <div class="sp-body">
            <div class="sp-stat"><span class="sp-stat-val">{{ stats.get("total_sources", 0) if stats is defined else 0 }}</span> Sources</div>
            <div class="sp-stat"><span class="sp-stat-val">{{ "{:,}".format(stats.get("total_words", 0) if stats is defined else 0) }}</span> Words</div>
            <div class="sp-stat"><span class="sp-stat-val">{{ stats.get("glossary_terms", 0) if stats is defined else 0 }}</span> Glossary</div>
        </div>
    </div>

    {# ── LLM Cost panel ─────────────────────────────────── #}
    {% if token_stats is defined and token_stats %}
    <div class="sp-panel sp-gold">
        <div class="sp-header">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
            <span>LLM Cost</span>
        </div>
        <div class="sp-body">
            <div class="sp-stat sp-stat-featured"><span class="sp-stat-val">${{ "%.4f"|format(token_stats.total_cost) }}</span> Cost</div>
            <div class="sp-stat"><span class="sp-stat-val">{{ "{:,}".format(token_stats.total_tokens) }}</span> Tokens</div>
            <div class="sp-stat"><span class="sp-stat-val">{{ token_stats.calls }}</span> Calls</div>
        </div>
    </div>
    {% endif %}

</div>

{# ── Session meta row (single card) ────────────────── #}
<div class="session-meta-bar">
    <div class="session-meta-metric">
        <span class="session-meta-label">Started</span>
        <span class="session-meta-value">{{ session.started_at.strftime('%Y-%m-%d %H:%M') if session is defined and session and session.started_at else "-" }}</span>
    </div>
    <div class="session-meta-metric">
        <span class="session-meta-label">Elapsed</span>
        <span class="session-meta-value">{% if el > 0 %}<span class="elapsed-timer" data-start="{{ el }}">{{ "%d:%02d:%02d"|format(el // 3600, (el % 3600) // 60, el % 60) }}</span>{% else %}-{% endif %}</span>
    </div>
    <div class="session-meta-metric">
        <span class="session-meta-label">Status</span>
        <span class="session-meta-value"><span class="session-status-pill session-status-{{ session_status }}">{{ session_status|replace("_", " ")|title }}</span></span>
    </div>
</div>
